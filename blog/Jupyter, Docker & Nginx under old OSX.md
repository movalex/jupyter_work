### Зачем (мне) это нужно
Для меня Jupyter — это удобная система ввода и просмотра кода, работающая через браузер. 
Иногда надо протестировать простой Python код, ну не делать же это в терминале! Не всегда есть возможность запустить IDE, не всегда есть физический доступ к машине со всеми установленными пакетами, и так далее. Когда работаешь в Jupyter, достаточно запустить браузер, подключиться по сети к компьютеру с запущенным сервером, ввести код, нажать CTRL+Enter и тут же увидеть результат. Не говоря уже о том, что с помощью Jupyter можно строить графики, изучать языки (в пакете, который использую я, кроме Python есть поддержка языков R и Julia), а также делать заметки или даже писать статьи на Markdown (кстати, эту статью я так и пишу).  К тому же, возможность предварительно комментировать код помогает, когда, например, надо пояснить условие задачи с Hackerrank. Вот так, например, выглядит моя страничка, посвященная алгоритмам. Красота же!

![](https://s3-eu-west-1.amazonaws.com/abogomolov/pictures/blog/algo_jpd.png)

Казалось бы, что проще, сделал `pip install jupyter`, запустил сервер и дело с концом. Но мы же легких путей не ищем. Нам нужны такие условия, которые позволяют иметь под рукой неизменный и полный набор инструментов в каждый момент времени, а это проще всего сделать с помощью Docker образа. Я давно хотел попытаться разобраться с этим способом работы с виртуальной операционной системой, и данный юзкейс подвернулся как раз вовремя. Я решил, что Jupyter  у меня будет работать из-под Docker, так что мне не придется настраивать вручную все языки и нужные пакеты, просто скачаю готовый образ, запущу и все будет работать. А если домашний сервер подведет, я могу легко воссоздать те же условия работы, запустив тот же образ на новой машине и перенеся рабочие файлы. Звучит заманчиво, однако если бы и это было так просто, то было бы неинтересно.

Да, действительно, сегодня установить Docker на современный Mac компьютер так же просто, как, скажем, налить чаю или установить игру из App Store. Скачал установщик, запустил, все работает. Файлы виртуальной машины будут автоматически доступны как снаружи сети, так и из вашей машины. 
Но, как оказалось, мой старый Mac Mini 2010 года не совместим с Docker for Mac. Поэтому вот ниже решение, как все вышеописанное чудо запустить вручную. Для этого, кстати, потребуется еще и nginx, но об этом позже.
### Настройка Docker
Итак, сначала мы устанавливаем [Docker Toolbox](https://download.docker.com/mac/stable/DockerToolbox.pkg). Напомню, что это legaсy-путь, только для старых компьютеров Apple, которые не поддерживают стандартный Docker.app. 
Проверить, поддерживает ли ваш компьютер виртуализацию менеджера памяти (MMU) можно с помощью команды

    sysctl kern.hv_support

Если ответ отличается от единицы, то добро пожаловать читать дальше.
Сейчас пробежимся кратко по шагам установки Docker. Подробные инструкции по установке можно прочитать [здесь](https://docs.docker.com/toolbox/toolbox_install_mac/).

![](https://docs.docker.com/toolbox/images/mac-page-quickstart.png)

Итак, сначала запускаем Docker Quickstart Terminal. Kitematic не понадобится, зачем нам интерфейс, мы же любим, когда всё по хардкору, так что настраивать все будем из терминала. В целом, на этом шаге уже все должно работать. Просто напишите 

    docker run --rm hello-world
    
чтобы убедиться, что тестовый образ скачался и запустился. Теперь можно скачать и установить любой подходящий образ Jupyter. Их довольно много, все зависит от предустановленных пакетов. Список всех доступных вариантов [здесь](https://github.com/jupyter/docker-stacks). Для начала можно выбрать base-image.

    docker pull jupyter/base-notebook

Затем запустим тестовый образ (используем порт 8888 как на хостовом компьютере, так и в виртуалке):

    docker run -it --rm -p 8888:8888 jupyter/base-notebook

Теперь самое время добавить больше параметров. Например, чтобы файлы, сгеренированные в Jupyter, были доступны локально без запуска Docker, нужно создать рабочую папку и связать ее с папкой внутри виртуальной машины. Для этого используем опцию `--volume`. По умолчанию наша виртуальная машина работает под управлением непривилегированного пользователя `jovyan`. Укажем докеру, что нам нужно смонтировать папку `work` домашней директории пользователя `jovyan` в домашней папке вашего хоста:  

    docker run -it --rm -d --name jplab --workdir /home/jovyan/work \
    -v /Users/barney/docker/work:/home/jovyan/work \
    -p 8888:8888 jupyter/base-notebook
    
Поскольку jupyter notebook должен быть доступен извне сети, хорошо озаботиться тем, чтобы в него можно было залогиниться только по паролю. Для этого можно воспользоваться запущенным на предыдущем этапе приложением. Создайте новый Python Jupyter notebook, откройте браузер на странице [localhost:8888](localhost:8888), чтобы сгенерировать пароль для Jupyter.

    from IPython.lib import passwd
    passwd()

Пролученный sha1:...-код нужно вставить при создании финального контейнера, с которым уже можно работать. Возможно, вам захочется сделать так, чтобы время внутри виртуальной машины было синзронизировано с временем вашего компьютера. Это будет не так просто, поскольку, напомню, это туториал для пользователей устаревших моделей mac. На новых компьютерах вся эта пляска с бубнами не нужна, достаточно поставить Docker for Mac, скачать образ и время будет синхронизироваться автоматически. На Linux это тоже просто: для синхронизации времени в Docker-образе используют команду  `-v /etc/localtime:/etc/localtime:ro`. На нашем старом mac это не сработает, поэтому придется скопировать содержимое /etc/localtime в локальную папку, например в ~/etc/timezone и использовать следующую команду.

    docker run -it -d --name jplab -e JUPYTER_ENABLE_LAB=1 \ 
    --workdir /home/jovyan/work -v /Users/barney/docker/work:/home/jovyan/work \
    -v ~/etc/timezone:/etc/localtime:ro -p 8888:8888 jupyter/datascience-notebook:latest \
    start-notebook.sh --NotebookApp.password=sha1:*** --NotebookApp.allow_origin=* --NotebookApp.base_url=/jp

Обратите внимание, что мы запустили образ `jupyter/datascience-notebook`, использовали кастомный скрипт `start-notebook.sh`, идущий в комплекте с этим образом, для того, чтобы задать параметр `base_url`, добавить пароль и использовать опцию `allow_origin`. Также с помощью `-e JUPYTER_ENABLE_LAB=1` активируется JupyterLab — новый интерфейс работы с Jupyter notebook. Очень рекомендую его попробовать, в нем [множество преимуществ](https://www.youtube.com/watch?time_continue=48&v=dSjvK-Z3o3U) по сравнению с классическим интерфейсом. Для запуска JupyterLab в конце адреса в веб-браузере замените `tree` на `lab`.

Теперь Jupyter должен работать локально на вашей машине по адресу `localhost:8888/jp`. Теперь осталось настроить веб-сервер так, чтобы наша Docker-виртуалка была видна извне сети. Сначала поставим Homebrew (если, конечно, вы этого по какой-то причине до сих пор не сделали). Вставьте в терминале:

    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

Требования к установке Homebrew можно найти [тут](https://docs.brew.sh/Installation).

### Теперь настроим прокси-сервер [nginx](https://en.wikipedia.org/wiki/Nginx):

Установка простая:

    brew install nginx

Немного изменим настройки nginx, чтобы наша docker машина была доступна извне. Для этого Nginx должен работать как прокси протокола Websocket. Подробнее об этом можно почитать [тут](https://www.nginx.com/blog/websocket-nginx/). Еще понадобится локальный ip-адрес, на котором работает докер-машина, его можно узнать командой: 
    
    docker-machine ip default

Обычно это `192.168.99.100`.

Итак, добавим в `/usr/local/etc/nginx/nginx.conf`:

```
    upstream websocket {
        server 192.168.99.100:8888;
        }

    server {
        listen       8888;
        server_name  localhost;

        location /jp {

            proxy_pass http://websocket/jp;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            client_max_body_size 10M;

        }
```
    
Теперь запустим nginx:
    
    nginx
    
и Jupyter должен стать доступен удаленно (при условии, что вы правильно настроили переадресацию портов на 8888).

Рекомендую также настроить логи для `nginx`. Я, например, столкнулся с тем, что при удаленном доступе вместо интерфейса jupyter была просто пустая страница. Без логов разобраться с этим было непросто. Однако посмотрев в файл `juypter_error.log`, оказалось, что ошибка связана с неправильными правами доступа к папке `/usr/local/var/run/nginx/proxy_temp`. Настроить логи можно, добавив в `nginx.conf` в раздел `http`, например, такое:


    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"' ;

    map $status $loggable {
        ~^[23]  0;
        default 1;
    }
    access_log  /usr/local/etc/nginx/log/juypter_access.log main if=$loggable;
    error_log   /usr/local/etc/nginx/log/juypter_error.log;

В этом случае `access-log` не будет заспамлен сообщениями об удачных операциях. Подробнее почитать про логи в Nginx можно [тут](https://docs.nginx.com/nginx/admin-guide/monitoring/logging/).

Вот и все, друзья!

P.S. Тем, кто хочет посмотреть на Docker повнимательнее, можно начать с [этой статьи](https://habrahabr.ru/post/310460/). 

P.P.S. Конечно, простого пароля доступа для настоящей секретности недостаточно. По хорошему, нужно настраивать доступ к Jupyter ноутбуку через SSL, а также включить авторизацию пользователей через JupyterHub. Но я с этим пока не разобрался. Думаю начать с регистрации на [LetsEncrypt](https://letsencrypt.org). Подробнее почитать о настройке доступа к Jupyter через https можно тут: [https://github.com/jupyterhub/...](https://github.com/jupyterhub/jupyterhub/wiki/Installation-of-Jupyterhub-on-remote-server)